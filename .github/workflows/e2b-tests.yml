name: E2B Live Site Tests

on:
  # Run daily at 6 AM UTC
  schedule:
    - cron: '0 6 * * *'

  # Run on push to main branch
  push:
    branches: [main, master]

  # Run on pull requests
  pull_request:
    branches: [main, master]

  # Allow manual trigger
  workflow_dispatch:

jobs:
  test-live-site:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Install ChromeDriver
        uses: nanasess/setup-chromedriver@v2

      - name: Install dependencies
        run: |
          pip install selenium webdriver-manager

      - name: Run live site tests
        id: tests
        run: |
          python test-live-site.py 2>&1 | tee test-output.txt
          # Check for test failures
          if grep -q "âŒ" test-output.txt; then
            echo "tests_passed=false" >> $GITHUB_OUTPUT
          else
            echo "tests_passed=true" >> $GITHUB_OUTPUT
          fi

      - name: Upload test screenshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-screenshots
          path: |
            test-screenshot.png
            error-screenshot.png
          if-no-files-found: ignore

      - name: Upload test output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-output
          path: test-output.txt

      - name: Create test summary
        if: always()
        run: |
          echo "## E2B Live Site Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** http://chess.genomicdigital.com" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Output" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat test-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Fail if tests failed
        if: steps.tests.outputs.tests_passed == 'false'
        run: exit 1

  collect-session-logs:
    runs-on: ubuntu-latest
    needs: test-live-site
    if: always() # Run even if tests fail

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install E2B and dependencies
        run: |
          pip install e2b-code-interpreter playwright
          playwright install chromium

      - name: Collect session logs
        run: |
          cd /Users/benfife/github/ammonfife/e2b/examples
          python collect_session_logs.py

      - name: Commit session logs to repo
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add session-logs/
          git commit -m "chore: Add session logs from automated testing [skip ci]" || echo "No changes to commit"
          git push

  notify-on-failure:
    needs: test-live-site
    if: failure()
    runs-on: ubuntu-latest

    steps:
      - name: Create failure issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ðŸš¨ E2B Test Failure - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            ## Automated Test Failure

            The daily E2B tests for ChessBlitz Arena have failed.

            **Workflow Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}

            **Time:** ${new Date().toISOString()}

            Please investigate and fix the failing tests.

            ---
            *This issue was automatically created by GitHub Actions*
            `;

            // Check if issue already exists today
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'e2b-test-failure'
            });

            const today = new Date().toISOString().split('T')[0];
            const existingIssue = issues.data.find(issue =>
              issue.title.includes(today)
            );

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['e2b-test-failure', 'automated']
              });
            }
